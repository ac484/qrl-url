---

# ä¸€ã€Domain Event â†’ Internal Event Busï¼ˆæ ¸å¿ƒéª¨å¹¹ï¼‰

## ğŸ¯ è¨­è¨ˆåŸå‰‡ï¼ˆDDDï¼‰

* Domain Event **ä¸å¯çŸ¥é“** WS / protobuf / async framework
* Event Bus æ˜¯ **Application å±¤åŸºç¤è¨­æ–½**
* Infrastructure åªè² è²¬ã€Œç™¼å¸ƒã€

---

## 1ï¸âƒ£ Domain Eventï¼ˆå·²å­˜åœ¨ï¼‰

```
domain/events/
  market_depth_event.py
  trade_event.py
  order_event.py
  balance_event.py
```

å…¨éƒ¨éƒ½æ˜¯ **ç´”è³‡æ–™ + ä¸å¯è®Š**

---

## 2ï¸âƒ£ Application Event Bus Port

### `application/events/event_bus.py`

```python
from typing import Protocol, Type, Callable, Awaitable, Any

DomainEvent = Any
EventHandler = Callable[[DomainEvent], Awaitable[None]]


class EventBus(Protocol):
    async def publish(self, event: DomainEvent) -> None: ...
    def subscribe(self, event_type: Type[DomainEvent], handler: EventHandler) -> None: ...
```

ğŸ‘‰ Application / Domain Service **åªä¾è³´é€™å€‹ä»‹é¢**

---

## 3ï¸âƒ£ In-Memory Event Busï¼ˆé è¨­å¯¦ä½œï¼‰

### `infrastructure/event_bus/in_memory_event_bus.py`

```python
from collections import defaultdict
from typing import Type, Dict, List

from app.application.events.event_bus import EventBus


class InMemoryEventBus(EventBus):

    def __init__(self):
        self._handlers: Dict[Type, List] = defaultdict(list)

    def subscribe(self, event_type, handler):
        self._handlers[event_type].append(handler)

    async def publish(self, event):
        for handler in self._handlers[type(event)]:
            await handler(event)
```

---

## 4ï¸âƒ£ Gateway â†’ Event Busï¼ˆæ•´åˆé»ï¼‰

```python
async for event in self._exchange.subscribe_trades(symbol):
    await self._event_bus.publish(event)
```

âœ” Domain Event é–‹å§‹åœ¨ç³»çµ±å…§ã€Œæµå‹•ã€

---

# äºŒã€Order / Trade / Balance Mapper å¥—ä»¶ï¼ˆå®Œæ•´ï¼‰

## ğŸ¯ åŸå‰‡

* **ä¸€å€‹èšåˆä¸€å€‹ mapper**
* Mapper åªåœ¨ Infrastructure
* Mapper åªè² è²¬ã€Œç¿»è­¯ã€

---

## 1ï¸âƒ£ Trade Mapper

### `adapters/trade_mapper.py`

```python
from app.domain.events.trade_event import TradeEvent
from app.domain.value_objects import Symbol, Price, Quantity, TradeId

from app.infrastructure.exchange.mexc.generated import (
    PublicDealsV3Api_pb2,
)


def trade_proto_to_domain(
    proto: PublicDealsV3Api_pb2.Deal
) -> TradeEvent:

    return TradeEvent(
        trade_id=TradeId(proto.dealId),
        symbol=Symbol(proto.symbol),
        price=Price(float(proto.price)),
        quantity=Quantity(float(proto.quantity)),
        is_buyer_maker=proto.isBuyerMaker,
        timestamp=proto.timestamp,
    )
```

---

## 2ï¸âƒ£ Order Mapper

### `adapters/order_mapper.py`

```python
from app.domain.events.order_event import OrderEvent
from app.domain.value_objects import OrderId, Symbol, Price, Quantity, OrderStatus

from app.infrastructure.exchange.mexc.generated import (
    PrivateOrdersV3Api_pb2,
)


def order_proto_to_domain(
    proto: PrivateOrdersV3Api_pb2.Order
) -> OrderEvent:

    return OrderEvent(
        order_id=OrderId(proto.orderId),
        symbol=Symbol(proto.symbol),
        price=Price(float(proto.price)),
        quantity=Quantity(float(proto.quantity)),
        status=OrderStatus.from_exchange(proto.status),
        timestamp=proto.timestamp,
    )
```

---

## 3ï¸âƒ£ Balance Mapper

### `adapters/balance_mapper.py`

```python
from app.domain.events.balance_event import BalanceEvent
from app.domain.value_objects import Asset, Quantity

from app.infrastructure.exchange.mexc.generated import (
    PrivateAccountV3Api_pb2,
)


def balance_proto_to_domain(
    proto: PrivateAccountV3Api_pb2.Balance
) -> BalanceEvent:

    return BalanceEvent(
        asset=Asset(proto.asset),
        free=Quantity(float(proto.free)),
        locked=Quantity(float(proto.locked)),
        timestamp=proto.timestamp,
    )
```

---

# ä¸‰ã€WS Backpressure / Replayï¼ˆäº¤æ˜“ç³»çµ±é—œéµï¼‰

## ğŸ¯ å•é¡Œæœ¬è³ª

* WS è³‡æ–™é€Ÿåº¦ > æ¶ˆè²»é€Ÿåº¦
* ç³»çµ±é‡å•Ÿä¸èƒ½ã€Œæ–·å±¤ã€
* å¿…é ˆ **å¯å›æ”¾ / å¯é™æµ**

---

## 1ï¸âƒ£ Backpressureï¼šAsync Queue

### `infrastructure/streaming/bounded_queue.py`

```python
import asyncio


class BoundedAsyncQueue:

    def __init__(self, max_size: int):
        self._queue = asyncio.Queue(maxsize=max_size)

    async def push(self, item):
        await self._queue.put(item)   # æ»¿äº†æœƒ block

    async def pull(self):
        return await self._queue.get()
```

---

## 2ï¸âƒ£ WS Client â†’ Queueï¼ˆç”Ÿç”¢è€…ï¼‰

```python
async for proto in ws_stream:
    await queue.push(proto)
```

---

## 3ï¸âƒ£ Adapter â†’ Event Busï¼ˆæ¶ˆè²»è€…ï¼‰

```python
while True:
    proto = await queue.pull()
    event = mapper(proto)
    await event_bus.publish(event)
```

---

## 4ï¸âƒ£ Replayï¼šRing Bufferï¼ˆçŸ­æœŸï¼‰

### `infrastructure/streaming/ring_buffer.py`

```python
from collections import deque


class RingBuffer:
    def __init__(self, size: int):
        self._buffer = deque(maxlen=size)

    def append(self, event):
        self._buffer.append(event)

    def replay(self):
        return list(self._buffer)
```

ğŸ‘‰ å¸¸ç”¨æ–¼ï¼š

* reconnect
* late subscriber
* debug

---

## 5ï¸âƒ£ ç”Ÿç”¢ç´š Replayï¼ˆå»¶ä¼¸ï¼‰

| å±¤ç´š | æŠ€è¡“           |
| -- | ------------ |
| è¼•é‡ | RingBuffer   |
| ä¸­å‹ | Redis Stream |
| é‡å‹ | Kafka        |

ğŸ‘‰ **ä»‹é¢ä¸€æ¨£ï¼Œå¯¦ä½œå¯æ›**

---

# å››ã€æ•´é«”è³‡æ–™æµï¼ˆä½ ç¾åœ¨çš„ç³»çµ±ï¼‰

```
MEXC WS
  â†“
protobuf
  â†“
BoundedQueue   â† backpressure
  â†“
Mapper         â† ç¿»è­¯
  â†“
Domain Event
  â†“
EventBus
  â†“
Application / Strategy / Persistence
```

---

# äº”ã€ç‚ºä»€éº¼é€™å¥—ã€Œæ’å¾—ä½å¯¦ç›¤ã€

* WS çˆ†é‡ â†’ Queue æ“‹
* Domain æ°¸é ä¹¾æ·¨
* ä»»ä½•äº¤æ˜“æ‰€ â†’ åŒä¸€ EventBus
* Replay / Debug / Test å…¨å¯ç”¨
* å¯ä»¥æ°´å¹³æ“´å……

---
