---

# ä¸€ã€æ•´é«”æ¶æ§‹ç¸½è¦½ï¼ˆDDD è¦–è§’ï¼‰

```
src/app
â”œâ”€ domain
â”‚  â”œâ”€ events
â”‚  â”‚   â”œâ”€ market_depth_event.py
â”‚  â”‚   â””â”€ trade_event.py
â”‚  â”œâ”€ value_objects
â”‚  â”‚   â”œâ”€ symbol.py
â”‚  â”‚   â”œâ”€ price.py
â”‚  â”‚   â””â”€ quantity.py
â”‚  â””â”€ entities
â”‚      â””â”€ order.py
â”‚
â”œâ”€ application
â”‚  â””â”€ ports
â”‚      â””â”€ exchange_gateway.py   â† â‘¢ Application Port
â”‚
â””â”€ infrastructure
   â””â”€ exchange
      â””â”€ mexc
         â”œâ”€ generated           â† *_pb2.py
         â”œâ”€ ws
         â”‚   â””â”€ mexc_ws_client.py
         â””â”€ adapters
             â”œâ”€ market_event_adapter.py   â† â‘  WS â†’ Domain Event
             â””â”€ order_mapper.py           â† â‘¡ proto â†’ Domain
```

---

# äºŒã€â‘¢ ExchangeGatewayï¼ˆApplication Portï¼‰

ğŸ‘‰ **Application åªèªã€Œèƒ½åŠ›ã€ï¼Œä¸èªå¯¦ä½œã€ä¸èª protobuf**

### `application/ports/exchange_gateway.py`

```python
from typing import Protocol, AsyncIterator
from app.domain.events.market_depth_event import MarketDepthEvent
from app.domain.events.trade_event import TradeEvent
from app.domain.value_objects.symbol import Symbol


class ExchangeGateway(Protocol):
    async def subscribe_market_depth(
        self, symbol: Symbol
    ) -> AsyncIterator[MarketDepthEvent]:
        ...

    async def subscribe_trades(
        self, symbol: Symbol
    ) -> AsyncIterator[TradeEvent]:
        ...
```

âœ” Application Service åªæœƒä¾è³´é€™å€‹
âœ” æœªä¾† Binance / OKX ç›´æ¥æ› Adapter

---

# ä¸‰ã€â‘  MEXC WebSocket â†’ Domain Event Adapter

ğŸ‘‰ é€™å±¤æ˜¯ **Infrastructure Adapter**
ğŸ‘‰ å¯ä»¥ç”¨ protobufã€JSONã€WSï¼Œ**Domain ä¸çŸ¥é“**

---

## 1ï¸âƒ£ Domain Eventï¼ˆç´” Domainï¼Œç„¡ protobufï¼‰

### `domain/events/market_depth_event.py`

```python
from dataclasses import dataclass
from app.domain.value_objects import Symbol, Price, Quantity


@dataclass(frozen=True)
class MarketDepthEvent:
    symbol: Symbol
    bids: list[tuple[Price, Quantity]]
    asks: list[tuple[Price, Quantity]]
    timestamp: int
```

---

## 2ï¸âƒ£ MEXC WS Clientï¼ˆæŠ€è¡“å±¤ï¼‰

### `infrastructure/exchange/mexc/ws/mexc_ws_client.py`

```python
class MexcWebSocketClient:
    async def subscribe(self, channel: str):
        """
        Yield raw protobuf bytes or decoded proto messages.
        """
        ...
```

âš ï¸ **é€™å±¤ä»ç„¶æ˜¯æŠ€è¡“ç´°ç¯€ï¼Œä¸é€² Domain**

---

## 3ï¸âƒ£ WS â†’ Domain Event Adapterï¼ˆæ ¸å¿ƒï¼‰

### `infrastructure/exchange/mexc/adapters/market_event_adapter.py`

```python
from typing import AsyncIterator
from app.application.ports.exchange_gateway import ExchangeGateway
from app.domain.events.market_depth_event import MarketDepthEvent
from app.domain.value_objects.symbol import Symbol

from app.infrastructure.exchange.mexc.generated import (
    PublicAggreDepthsV3Api_pb2,
)
from app.infrastructure.exchange.mexc.ws.mexc_ws_client import MexcWebSocketClient
from app.infrastructure.exchange.mexc.adapters.order_mapper import (
    depth_proto_to_domain,
)


class MexcExchangeGateway(ExchangeGateway):

    def __init__(self, ws_client: MexcWebSocketClient):
        self._ws = ws_client

    async def subscribe_market_depth(
        self, symbol: Symbol
    ) -> AsyncIterator[MarketDepthEvent]:

        async for proto_msg in self._ws.subscribe(
            channel=f"depth:{symbol.value}"
        ):
            domain_event = depth_proto_to_domain(proto_msg)
            yield domain_event
```

âœ” å¯¦ä½œ Application Port
âœ” protobuf **åªå­˜åœ¨ Infrastructure**

---

# å››ã€â‘¡ proto â†’ Domain Entity / Event Mapperï¼ˆæœ€é‡è¦ï¼‰

ğŸ‘‰ **å”¯ä¸€å…è¨± proto â†’ domain çš„åœ°æ–¹**

---

## `infrastructure/exchange/mexc/adapters/order_mapper.py`

```python
from app.domain.events.market_depth_event import MarketDepthEvent
from app.domain.value_objects import Symbol, Price, Quantity

from app.infrastructure.exchange.mexc.generated import (
    PublicAggreDepthsV3Api_pb2,
)


def depth_proto_to_domain(
    proto: PublicAggreDepthsV3Api_pb2.Depth
) -> MarketDepthEvent:

    bids = [
        (Price(float(p.price)), Quantity(float(p.quantity)))
        for p in proto.bids
    ]

    asks = [
        (Price(float(p.price)), Quantity(float(p.quantity)))
        for p in proto.asks
    ]

    return MarketDepthEvent(
        symbol=Symbol(proto.symbol),
        bids=bids,
        asks=asks,
        timestamp=proto.timestamp,
    )
```

### âš  åš´æ ¼åŸå‰‡ï¼ˆä½ å·²ç¶“è¸©åœ¨æ­£ç¢ºè·¯ä¸Šï¼‰

* âŒ Domain ä¸ import `_pb2`
* âŒ Application ä¸çŸ¥é“ WS / protobuf
* âœ… Infrastructure Adapter æ‰¿æ“”ã€Œç¿»è­¯è²¬ä»»ã€

---

# äº”ã€Application Service ä½¿ç”¨æ–¹å¼ï¼ˆä¹¾æ·¨ï¼‰

```python
class MarketService:
    def __init__(self, exchange: ExchangeGateway):
        self._exchange = exchange

    async def run(self):
        async for event in self._exchange.subscribe_market_depth(
            Symbol("BTCUSDT")
        ):
            self.handle(event)
```

ğŸ‘‰ **é€™è£¡å®Œå…¨ä¸çŸ¥é“ MEXCã€protobufã€WS**

---

# å…­ã€ç‚ºä»€éº¼é€™å¥—è¨­è¨ˆã€Œä¸æœƒçˆ†ç‚¸ã€

| é¢å‘         | çµæœ                    |
| ---------- | --------------------- |
| import ç©©å®šæ€§ | âœ… ä¸æœƒ                  |
| proto è®Šå‹•   | âœ… åªå½±éŸ¿ adapter         |
| äº¤æ˜“æ‰€åˆ‡æ›      | âœ… æ›ä¸€å€‹ Gateway         |
| æ¸¬è©¦         | âœ… FakeExchangeGateway |
| DDD ç´”åº¦     | âœ… é«˜                   |

---
